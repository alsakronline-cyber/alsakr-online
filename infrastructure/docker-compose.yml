services:
  # FastAPI Backend
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: alsakr-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - OLLAMA_HOST=http://ollama:11434
      - QDRANT_HOST=http://qdrant:6333
      - REDIS_URL=redis://redis:6379
      - SELENIUM_HOST=selenium
      - N8N_WEBHOOK_URL=http://n8n:5678/webhook
    depends_on:
      - qdrant
      - redis
      - selenium
      - pocketbase
      - ollama
    volumes:
      - backend_data:/app/data
    networks:
      - alsakr-network

  # Next.js Frontend
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: alsakr-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=https://api.app.alsakronline.com
    networks:
      - alsakr-network

  # Ollama AI Server (CPU Mode for standard ARM instances, GPU if available)
  ollama:
    image: ollama/ollama:latest
    container_name: alsakr-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - alsakr-network

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: alsakr-qdrant
    restart: unless-stopped
    ports:
      - "127.0.0.1:6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - alsakr-network

  # PocketBase (Auth & DB)
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: alsakr-pocketbase
    restart: unless-stopped
    ports:
      - "127.0.0.1:8090:8090"
    volumes:
      - pocketbase_data:/pb_data
    networks:
      - alsakr-network

  # n8n Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: alsakr-n8n
    restart: unless-stopped
    ports:
      - "127.0.0.1:5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASS:-password}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - alsakr-network

  # Caddy Reverse Proxy
  caddy:
    image: caddy:2-alpine
    container_name: alsakr-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - alsakr-network

  # Redis Cache
  redis:
    image: redis:alpine
    container_name: alsakr-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - alsakr-network

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: alsakr-prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    ports:
      - "127.0.0.1:9090:9090"
    networks:
      - alsakr-network

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: alsakr-grafana
    restart: unless-stopped
    ports:
      - "127.0.0.1:3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - alsakr-network

  # Selenium Chrome (ARM64 Compatible)
  selenium:
    image: seleniarm/standalone-chromium:latest
    container_name: alsakr-selenium
    restart: unless-stopped
    ports:
      - "4444:4444"
      - "7900:7900"
    shm_size: "2gb"
    networks:
      - alsakr-network

networks:
  alsakr-network:
    driver: bridge

volumes:
  backend_data:
  ollama_data:
  qdrant_data:
  pocketbase_data:
  n8n_data:
  caddy_data:
  caddy_config:
  redis_data:
  prometheus_data:
  grafana_data:
